package com.softwareverde.bitcoin.transaction;

import com.softwareverde.bitcoin.test.UnitTest;
import com.softwareverde.constable.bytearray.ByteArray;
import com.softwareverde.json.Json;
import com.softwareverde.util.bytearray.ByteArrayReader;
import org.junit.After;
import org.junit.Assert;
import org.junit.Before;
import org.junit.Test;

public class TransactionInflaterTests extends UnitTest {
    @Before
    public void before() throws Exception {
        super.before();
    }

    @After
    public void after() throws Exception {
        super.after();
    }

    @Test
    public void should_cache_correct_byte_count() throws Exception {
        // Setup
        final ByteArrayReader byteArrayReader = new ByteArrayReader(ByteArray.fromHexString("0100000001B7149E391C7695D0E3EF07562119074A153C86B57032279BAB6280F3381304CE000000006A473044022059DCCEB41A3647FD79225E425F787CE2B5D09593A08BF66F6263CF6AB492611C02205D5EABBD5F36748CE87B9D8361E6739FE03E44B9DED8B4134B68921212F8084E412102ABAAD90841057DDB1ED929608B536535B0CD8A18BA0A90DBA66BA7B1C1F7B4EAFEFFFFFF02102700000000000040EFB7149E391C7695D0E3EF07562119074A153C86B57032279BAB6280F3381304CE10FE15CD5B0776A9140A373CAF0AB3C2B46CD05625B8D545C295B93D7A88ACC4C9052A010000001976A914EA873AAAFBDD7A7C74D73EE1174E42F620B0A18C88AC00000000"));
        final Integer expectedByteCount = 264;

        final TransactionInflater transactionInflater = new TransactionInflater();

        // Action
        final Transaction transaction = transactionInflater.fromBytes(byteArrayReader);
        final Transaction constTransaction = transaction.asConst();

        // Assert
        Assert.assertEquals(expectedByteCount, transaction.getByteCount());
        Assert.assertEquals(expectedByteCount, constTransaction.getByteCount());
    }

    @Test
    public void should_deflate_cash_token_json() throws Exception {
        // Setup
        final TransactionInflater transactionInflater = new TransactionInflater();
        final Transaction transaction = transactionInflater.fromBytes(ByteArray.fromHexString("02000000026439F9B00896BDB3FA9874DCA3C4BF95443845A18BB14576995B55903F715F4100000000644103DC7AF20842AB45D822010BA9F6BF5E6DE1B3D062B2EDD94DA9F9C5D9BC7CA8D9EA6D1423A8BA7E362F1A2D275618B7409F2059404D5314F2045ED0D1923ED361210286A8BCF759F185897BABFC08D69C84DCC627FA70F8952D4152F1F6AFB186FD3B0000000091B0BE5AA5D9B45FD4ECC8600D67B6FEC2ABC5A6CA0D5852F4885554A94E4C94000000006441B5D5AC7AB97825EED84EE48B8748D48719DEAA83995B8A6C8061D3EDA5286A8B9AEF4C09AC99ECC230264B4B9B707E732554BCACC9A74C7843567A6F0F7BB29661210286A8BCF759F185897BABFC08D69C84DCC627FA70F8952D4152F1F6AFB186FD3B0000000009A08601000000000042EF91B0BE5AA5D9B45FD4ECC8600D67B6FEC2ABC5A6CA0D5852F4885554A94E4C9431FF08FEFEFFFEFFFF7FA91406C841F122AFB58B095C30E238E769BF082244DA8710270000000000006EEF6439F9B00896BDB3FA9874DCA3C4BF95443845A18BB14576995B55903F715F41622801020304050607080910111213141516171819202122232425262728293031323334353637383940AA206F906E2C68BCE70EED90113203158CAE49F072AC7A3A02257BA76BE68A80DB1F8710270000000000006EEF91B0BE5AA5D9B45FD4ECC8600D67B6FEC2ABC5A6CA0D5852F4885554A94E4C9410FEFFFFFFFF52210286A8BCF759F185897BABFC08D69C84DCC627FA70F8952D4152F1F6AFB186FD3B21028E068C5CD8DE3E20625F3DF40AA5A84D97552F326001160C793A0EB78B5E7F2C52AE10270000000000003EEF91B0BE5AA5D9B45FD4ECC8600D67B6FEC2ABC5A6CA0D5852F4885554A94E4C9410FDFFFF76A914C5EB5DDE0EFE57884810D3E5ADA12C6ADA6A06B188AC102700000000000048EF91B0BE5AA5D9B45FD4ECC8600D67B6FEC2ABC5A6CA0D5852F4885554A94E4C9410FDFD00210286A8BCF759F185897BABFC08D69C84DCC627FA70F8952D4152F1F6AFB186FD3BAC102700000000000046EF91B0BE5AA5D9B45FD4ECC8600D67B6FEC2ABC5A6CA0D5852F4885554A94E4C9410FC210286A8BCF759F185897BABFC08D69C84DCC627FA70F8952D4152F1F6AFB186FD3BAC204E00000000000041EF91B0BE5AA5D9B45FD4ECC8600D67B6FEC2ABC5A6CA0D5852F4885554A94E4C94600568656C6C6F76A914C5EB5DDE0EFE57884810D3E5ADA12C6ADA6A06B188ACE80300000000000040EF91B0BE5AA5D9B45FD4ECC8600D67B6FEC2ABC5A6CA0D5852F4885554A94E4C946004F09F8C8E76A914C5EB5DDE0EFE57884810D3E5ADA12C6ADA6A06B188AC0000000000000000116A04010101010A43617368546F6B656E7300000000"));

        // Action
        final Json transactionJson = transaction.toJson();

        // Assert
        final Json cashTokenJson = transactionJson.get("outputs").get(0).getOrNull("cashToken", Json.Types.JSON);
        Assert.assertNotNull(cashTokenJson);
    }
}
